{% extends "index.html" %} {% block title %} - Kartu Putih{% endblock %} {%
block content %}
<div class="!w-full">
  <div class="card bg-base-100 w-full shadow-sm mt-2">
    <div class="card-body">
      <h1 class="text-3xl font-bold mb-4">Kartu Putih</h1>
      <form action="#" id="form">
        <input type="hidden" id="p1" name="p1" />
        <input type="hidden" id="p2" name="p2" />
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">NIM Mahasiswa</span>
          </div>
          <div id="nim" class="mx-auto my-2"></div>
        </label>
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Nama Mahasiswa</span>
          </div>
          <div id="nama" class="mx-auto my-2"></div>
        </label>
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Program Studi Mahasiswa</span>
          </div>
          <div id="prodi" class="mx-auto my-2"></div>
        </label>
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Pembimbing 1 Mahasiswa</span>
          </div>
          <div id="pembimbing-1" class="mx-auto my-2"></div>
        </label>
        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Pembimbing 2 Mahasiswa</span>
          </div>
          <div id="pembimbing-2" class="mx-auto my-2"></div>
        </label>
        <label class="form-control !w-full">
          <div class="label">
            <span class="label-text">Judul Proposal Mahasiswa</span>
          </div>
          <textarea
            rows="1"
            data-autoresize
            class="textarea textarea-bordered resize-none overflow-hidden !w-full my-2 !min-h-0 leading-[1.5rem]"
            placeholder="Masukkan Judul Proposal Mahasiswa"
            oninput="autoResize(this)"
            required
          ></textarea>
        </label>
        <label class="form-control !w-full">
          <div class="label">
            <span class="label-text">Nomor Surat Tugas</span>
          </div>
          <input
            id="nomor-surat"
            class="input input-bordered !w-full my-2"
            name="nomor_surat"
            type="number"
            placeholder="Masukkan Nomor Surat Tugas"
            required
          />
        </label>
        <label class="form-control !w-full">
          <div class="label">
            <span class="label-text">Tanggal Surat Tugas</span>
          </div>
          <input
            id="tanggal-surat"
            class="input input-bordered !w-full my-2"
            type="text"
            required
          />
        </label>

        <div class="card-actions justify-start flex-row-reverse">
          <button class="btn btn-primary" id="button-submit" type="submit">
            Simpan
          </button>
          <button class="btn btn-error" type="reset">Reset</button>
        </div>
      </form>
    </div>
  </div>
  <div id="table" class="mx-auto my-4"></div>
</div>
<dialog id="delete-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Konfirmasi</h3>
    <p class="py-4">Yakin ingin menghapus data ini?</p>
    <div class="modal-action">
      <button class="btn btn-outline btn-sm" id="cancel-delete">Batal</button>
      <button class="btn btn-error btn-sm" id="confirm-delete">Hapus</button>
    </div>
  </div>
</dialog>
<dialog id="editModal" class="modal">
  <div class="modal-box w-full max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Edit Data Kartu Putih</h3>
    <form id="editForm">
      <input type="hidden" id="edit-id" />

      <label class="form-control !w-full">
        <div class="label">
          <span class="label-text">NIM</span>
        </div>
        <input
          id="edit-nim"
          type="text"
          class="input input-bordered !w-full my-2"
          required
        />
      </label>

      <label class="form-control !w-full">
        <div class="label">
          <span class="label-text">Judul</span>
        </div>
        <textarea
          id="edit-judul"
          class="textarea textarea-bordered !w-full my-2 resize-none"
          rows="2"
          required
        ></textarea>
      </label>

      <label class="form-control !w-full">
        <div class="label">
          <span class="label-text">Tanggal Surat Tugas</span>
        </div>
        <input
          id="edit-tanggal"
          class="input input-bordered !w-full my-2"
          type="text"
          required
        />
      </label>

      <label class="form-control !w-full">
        <div class="label">
          <span class="label-text">Nomor Surat</span>
        </div>
        <input
          id="edit-nomor"
          type="text"
          class="input input-bordered !w-full my-2"
          required
        />
      </label>

      <label class="form-control !w-full">
        <div class="label">
          <span class="label-text">Pembimbing 1</span>
        </div>
        <input
          id="edit-p1"
          type="text"
          class="input input-bordered !w-full my-2"
          required
        />
      </label>

      <label class="form-control !w-full">
        <div class="label">
          <span class="label-text">Pembimbing 2</span>
        </div>
        <input
          id="edit-p2"
          type="text"
          class="input input-bordered !w-full my-2"
          required
        />
      </label>

      <div class="modal-action pt-4">
        <button type="submit" class="btn btn-primary">Simpan</button>
        <button type="button" class="btn" onclick="editModal.close()">
          Batal
        </button>
      </div>
    </form>
  </div>
</dialog>

{% endblock %} {% block scripts %}
<script>
  function toObject(fd) {
    return Object.fromEntries(fd.entries());
  }
  function autoResize(el) {
    el.style.height = "auto";
    el.style.height = el.scrollHeight + "px";
  }
  function recalcAll() {
    document.querySelectorAll("textarea[data-autoresize]").forEach(autoResize);
  }
  window.addEventListener("resize", recalcAll);
  window.addEventListener("DOMContentLoaded", recalcAll);

  const form = document.getElementById("form");
  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    let data = toObject(formData);
    data["judul"] = document.querySelector("textarea").value;
    data["tanggal"] = document.getElementById("tanggal-surat").dataset.rawDate;

    const buttonSubmit = document.getElementById("button-submit");
    buttonSubmit.disabled = true;
    buttonSubmit.textContent = "Menyimpan...";
    console.log("Form payload to submit:", data);

    try {
      const res = await fetch("/api/post/kartu-putih", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!res.ok) throw new Error("Gagal menyimpan data");

      const json = await res.json();
      if (json.success) {
        showToast("Data berhasil disimpan", "success");
        window.table.load();
        form.reset();
        document.querySelector("textarea").value = "";
        document.getElementById("tanggal-surat").value = "";
        tanggalSurat.setDate(new Date());

        nimAutocomplete.clearInput();
        namaAutocomplete.clearInput();
        prodiAutocomplete.clearInput();
        pembimbing1Autocomplete.clearInput();
        pembimbing2Autocomplete.clearInput();
      } else {
        showToast("Gagal menyimpan: " + JSON.stringify(json), "error");
      }
    } catch (err) {
      console.error(err);
      showToast("Terjadi kesalahan saat menyimpan data", "error");
    } finally {
      buttonSubmit.disabled = false;
      buttonSubmit.textContent = "Simpan";
    }
  });
  document.getElementById("editForm").onsubmit = async (e) => {
    e.preventDefault();
    const data = {
      id_kartu: document.getElementById("edit-id").value,
      nim: document.getElementById("edit-nim").value,
      judul: document.getElementById("edit-judul").value,
      tanggal: document.getElementById("edit-tanggal").value,
      nomor_surat: document.getElementById("edit-nomor").value,
      p1: document.getElementById("edit-p1").value,
      p2: document.getElementById("edit-p2").value,
    };

    try {
      const res = await fetch("/api/update/kartu-putih", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      const result = await res.json();
      if (result.success) {
        showToast("Berhasil diperbarui!", "success");
        await dataTable.load();
        editModal.close();
      } else {
        showToast(result.error || "Gagal memperbarui!", "error");
      }
    } catch (err) {
      showToast("Terjadi kesalahan saat memperbarui", "error");
    }
  };
</script>
<script type="module">
  import DatePicker from "/static/js/datepicker/datepicker.js";
  window.tanggalSurat = new DatePicker("#tanggal-surat", {
    showResetButton: true,
    resetBehavior: "today",
    defaultDate: new Date(),
    selectDefaultDate: true,
    dateFormat: "DD MMMM YYYY",
    todayLabel: "Hari Ini",
    locale: "id-ID",
    placeholder: "Masukkan Tanggal Surat Tugas",
    inputName: "tanggal",
    onSelect(d, iso) {
      console.log("picked", iso);
    },
  });
  window.editTanggal = new DatePicker("#edit-tanggal", {
    showResetButton: true,
    resetBehavior: "today",
    defaultDate: new Date(),
    selectDefaultDate: true,
    dateFormat: "DD MMMM YYYY",
    todayLabel: "Hari Ini",
    locale: "id-ID",
    placeholder: "Masukkan Tanggal Surat Tugas",
    inputName: "tanggal",
    onSelect(d, iso) {
      console.log("picked", iso);
    },
  });
</script>
<script type="module">
  import { createAutocomplete } from "/static/js/autocomplete/autocomplete.js";

  const data = [
    { name: "Lorem ipsum", nim: "2102022432", prodi: "Akuntansi" },
    { name: "Dolor sit", nim: "2102014324", prodi: "Manajemen" },
    { name: "Amet Consectetur", nim: "2102022384", prodi: "Akuntansi" },
  ];

  const nimContainer = document.getElementById("nim");
  const namaContainer = document.getElementById("nama");
  const prodiContainer = document.getElementById("prodi");
  const pembimbing1Container = document.getElementById("pembimbing-1");
  const pembimbing2Container = document.getElementById("pembimbing-2");

  window.nimAutocomplete = createAutocomplete({
    container: nimContainer,
    // options: data,
    displayFields: ["nim", "nama", "prodi"],
    searchFields: ["nim"],
    selectedFields: ["nim"],
    minChars: 3,
    debounceMs: 300,
    placeholder: "Masukkan NIM Mahasiswa",
    showInfoMessage: true,
    infoMessage: "Pilih Mahasiswa",
    required: true,
    showClearButton: true,
    clearValue: { nim: "", nama: "", prodi: "" },
    autocompleteAttr: "off",
    name: "nim",
    fetchOptions: async (query) => {
      const res = await fetch(
        `/api/get/mahasiswa?q=${encodeURIComponent(query)}`
      );
      if (!res.ok) return [];
      return await res.json();
    },
    onSelect: (item) => {
      namaAutocomplete.setRawValue(item.nama);
      prodiAutocomplete.setValueBySearch(item.prodi);
    },
    onNoMatch: (text) => {
      namaAutocomplete.clearInput();
      prodiAutocomplete.clearInput();
    },
  });

  window.namaAutocomplete = createAutocomplete({
    container: namaContainer,
    // options: data,
    displayFields: ["nim", "nama", "prodi"],
    searchFields: ["nama"],
    selectedFields: ["nama"],
    minChars: 3,
    debounceMs: 300,
    // useFuzzy: true,
    // fuse: Fuse,
    // fuseOptions: { threshold: 0.3 },
    placeholder: "Masukkan Nama Mahasiswa",
    clearValue: { nim: "", nama: "", prodi: "" },
    showInfoMessage: true,
    infoMessage: "Pilih Mahasiswa",
    required: true,
    showClearButton: true,
    autocompleteAttr: "off",
    name: "nama",
    fetchOptions: async (query) => {
      const res = await fetch(
        `/api/get/mahasiswa?q=${encodeURIComponent(query)}`
      );
      if (!res.ok) return [];
      return await res.json();
    },
    onSelect: (item) => {
      nimAutocomplete.setRawValue(item.nim);
      prodiAutocomplete.setValueBySearch(item.prodi);
    },
    onNoMatch: (text) => {
      nimAutocomplete.clearInput();
      prodiAutocomplete.clearInput();
    },
  });

  window.prodiAutocomplete = createAutocomplete({
    container: prodiContainer,
    options: [{ namaProdi: "Akuntansi" }, { namaProdi: "Manajemen" }],
    displayFields: ["namaProdi"],
    searchFields: ["namaProdi"],
    selectedFields: ["namaProdi"],
    showInfoMessage: true,
    infoMessage: "Pilih Prodi",
    minChars: 3,
    debounceMs: 300,
    placeholder: "Masukkan Program Studi Mahasiswa",
    clearValue: { namaProdi: "" },
    required: true,
    showClearButton: true,
    autocompleteAttr: "off",
    name: "prodi",
    onSelect: (item) => {
      console.log("User picked:", item);
    },
  });

  window.pembimbing1Autocomplete = createAutocomplete({
    container: pembimbing1Container,
    // options: data,
    displayFields: ["nama", "prodi"],
    searchFields: ["nama"],
    selectedFields: ["nama"],
    minChars: 3,
    debounceMs: 300,
    useCache: false,
    placeholder: "Masukkan Pembimbing 1 Mahasiswa",
    required: true,
    showClearButton: true,
    autocompleteAttr: "off",
    name: "showp1",
    fetchOptions: async (query) => {
      let prodi = prodiAutocomplete.getValue();
      const res = await fetch(
        `/api/get/dosen?q=${encodeURIComponent(query)}&prodi=${prodi}`
      );
      if (!res.ok) return [];
      return await res.json();
    },
    onSelect: (item) => {
      console.log("User picked:", item);
      const p1 = document.getElementById("p1");
      p1.value = item["id_dosen"];
      //   namaAutocomplete.setRawValue(item.nama);
      //   prodiAutocomplete.setValueBySearch(item.prodi);
    },
  });

  window.pembimbing2Autocomplete = createAutocomplete({
    container: pembimbing2Container,
    // options: data,
    displayFields: ["nama", "prodi"], // what user sees
    searchFields: ["nama"],
    selectedFields: ["nama"],
    minChars: 3,
    debounceMs: 300,
    useCache: false,
    placeholder: "Masukkan Pembimbing 2 Mahasiswa",
    required: true,
    showClearButton: true,
    autocompleteAttr: "off",
    name: "showp2",
    fetchOptions: async (query) => {
      let prodi = prodiAutocomplete.getValue();
      const res = await fetch(
        `/api/get/dosen?q=${encodeURIComponent(query)}&prodi=${prodi}`
      );
      if (!res.ok) return [];
      return await res.json();
    },
    onSelect: (item) => {
      console.log("User picked:", item);
      const p2 = document.getElementById("p2");
      p2.value = item["id_dosen"];
      //   namaAutocomplete.setRawValue(item.nama);
      //   prodiAutocomplete.setValueBySearch(item.prodi);
    },
  });
</script>

<script type="module">
  import DataTable from "/static/js/datatable/datatable.js";
  const nomorSurat = document.getElementById("nomor-surat");
  window.table = new DataTable({
    container: "#table",
    columns: [
      { key: "id_kartu", label: "ID" },
      { key: "nim", label: "NIM" },
      { key: "nama", label: "Nama Mahasiswa" },
      { key: "prodi", label: "Program Studi" },
      { key: "p1", label: "Pembimbing 1" },
      { key: "p2", label: "Pembimbing 2" },
      { key: "judul", label: "Judul" },
      {
        key: "nomor_surat",
        label: "Nomor Surat",
        format: (_v, row) =>
          row.nomor_surat
            ? `${row.nomor_surat}/FEBP/UNHI/${monthToRoman(row.tanggal)}/${
                parseDate(row.tanggal)[0]
              }`
            : "-",
      },
      {
        key: "tanggal",
        label: "Tanggal Surat",
        format: (_v, row) =>
          row.tanggal ? formatDateToLongID(row.tanggal) : "-",
      },
      {
        key: "action",
        label: "Aksi",
        format: (_v, row) => {
          const container = document.createElement("div");
          container.className = "join";
          const btnEdit = document.createElement("button");
          btnEdit.className = "btn btn-xs btn-primary join-item";
          btnEdit.textContent = "Ubah";
          // btnEdit.onclick = () => {
          //   console.log("Edit row", row);
          //   nimAutocomplete.setRawValue(row.nim);
          //   namaAutocomplete.setRawValue(row.nama);
          //   prodiAutocomplete.setValueBySearch(row.prodi);
          //   pembimbing1Autocomplete.setRawValue(row.p1);
          //   pembimbing2Autocomplete.setRawValue(row.p2);
          //   document.querySelector("textarea").value = row.judul;
          //   tanggalSurat.setDate(row.tanggal);
          //   nomorSurat.value = row.nomor_surat;
          //   const p1 = document.getElementById("p1");
          //   const p2 = document.getElementById("p2");
          //   p1.value = row.p1_id;
          //   p2.value = row.p2_id;
          // };
          btnEdit.onclick = () => {
            // Fill modal fields
            document.getElementById("edit-id").value = row.id_kartu;
            document.getElementById("edit-nim").value = row.nim;
            document.getElementById("edit-judul").value = row.judul;
            window.editTanggal.setDate(row.tanggal);
            document.getElementById("edit-nomor").value = row.nomor_surat;
            document.getElementById("edit-p1").value = row.pembimbing_1;
            document.getElementById("edit-p2").value = row.pembimbing_2;
            editModal.showModal();
          };

          const btnDelete = document.createElement("button");
          btnDelete.className = "btn btn-xs btn-error join-item";
          btnDelete.textContent = "Hapus";
          btnDelete.onclick = () => {
            console.log("Delete row", row);
            deleteRowData = row;
            deleteModal.showModal(); // DaisyUI modal open
          };

          container.append(btnEdit, btnDelete);
          return container;
        },
      },
    ],
    persistSelection: true, // remember!
    rowIdKey: "id_kartu", // unique field
    storageKey: "kartu-putih-table-selections",
    onPrint: (sel, inst) => {
      console.log("About to print", sel.length, "rows:", sel);
      console.log(inst);
      // your custom print logic here
    },
    onSelect: (rows) => {
      console.log("Selection changed:", rows);
    },
    dataLoader: () => fetch("/api/get/kartu-putih/").then((res) => res.json()),
  });
</script>
<script>
  const deleteModal = document.getElementById("delete-modal");
  const cancelBtn = document.getElementById("cancel-delete");
  const confirmBtn = document.getElementById("confirm-delete");

  let deleteRowData = null;

  cancelBtn.onclick = () => {
    deleteRowData = null;
    deleteModal.close(); // DaisyUI modal close
  };

  confirmBtn.onclick = async () => {
    if (!deleteRowData) return;
    const res = await fetch(
      "/api/delete/kartu-putih/" + deleteRowData.id_kartu,
      {
        method: "DELETE",
      }
    );
    if (res.ok) {
      showToast("Berhasil dihapus!", "success");
      window.table.load(); // or your public DataTable instance
    } else {
      showToast("Gagal menghapus data!", "error");
    }
    deleteModal.close();
  };
</script>
{% endblock %}
